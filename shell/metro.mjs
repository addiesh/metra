/**
 * Metro JS shell
 * Made with Love (care) and Hate (web development)
 * Â© addie.sh 2025
 */

console.info(
	"%c   ",
	// TODO: optimize the project-wide logo instead of creating a subset
	"font-size:128px;background:local url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgNSAzMiAyMiI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJlIj48c3RvcCBvZmZzZXQ9IjAiIHN0eWxlPSJzdG9wLWNvbG9yOiMwYzE1MjEiLz48c3RvcCBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiMzNTNjNTgiLz48L2xpbmVhckdyYWRpZW50PjxsaW5lYXJHcmFkaWVudCBpZD0iZiI+PHN0b3Agb2Zmc2V0PSIwIiBzdHlsZT0ic3RvcC1jb2xvcjojZmZmO3N0b3Atb3BhY2l0eTouNyIvPjxzdG9wIG9mZnNldD0iMSIgc3R5bGU9InN0b3AtY29sb3I6I2ZmZjtzdG9wLW9wYWNpdHk6MCIvPjwvbGluZWFyR3JhZGllbnQ+PGxpbmVhckdyYWRpZW50IGlkPSJkIj48c3RvcCBvZmZzZXQ9IjAiIHN0eWxlPSJzdG9wLWNvbG9yOiMwZWZmMGUiLz48c3RvcCBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiM4MmZmODIiLz48L2xpbmVhckdyYWRpZW50PjxsaW5lYXJHcmFkaWVudCBpZD0iYyI+PHN0b3Agb2Zmc2V0PSIwIiBzdHlsZT0ic3RvcC1jb2xvcjojZmZjYjAwIi8+PHN0b3Agb2Zmc2V0PSIxIiBzdHlsZT0ic3RvcC1jb2xvcjojZmZlNTc1Ii8+PC9saW5lYXJHcmFkaWVudD48bGluZWFyR3JhZGllbnQgaWQ9ImIiPjxzdG9wIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6I2ZmMjYyNiIvPjxzdG9wIG9mZnNldD0iMSIgc3R5bGU9InN0b3AtY29sb3I6I2ZmNWM1YyIvPjwvbGluZWFyR3JhZGllbnQ+PGxpbmVhckdyYWRpZW50IGlkPSJhIj48c3RvcCBvZmZzZXQ9IjAiIHN0eWxlPSJzdG9wLWNvbG9yOiM1MjZhY2MiLz48c3RvcCBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiNlZGYwZmEiLz48L2xpbmVhckdyYWRpZW50PjxsaW5lYXJHcmFkaWVudCBpZD0iZyIgeDE9IjE2LjUiIHgyPSIyMC41IiB5MT0iMjciIHkyPSIzIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgaHJlZj0iI2EiLz48bGluZWFyR3JhZGllbnQgaWQ9Im4iIHgxPSI3IiB4Mj0iOC41IiB5MT0iMjQiIHkyPSIxOCIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIGhyZWY9IiNiIi8+PGxpbmVhckdyYWRpZW50IGlkPSJvIiB4MT0iMTciIHgyPSIxOC41IiB5MT0iMjQiIHkyPSIxOCIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIGhyZWY9IiNjIi8+PGxpbmVhckdyYWRpZW50IGlkPSJwIiB4MT0iMjUiIHgyPSIyNi41IiB5MT0iMjQiIHkyPSIxOCIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIGhyZWY9IiNkIi8+PGxpbmVhckdyYWRpZW50IGlkPSJoIiB4MT0iMjQuNSIgeDI9IjEyLjUiIHkxPSIyNSIgeTI9IjciIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBocmVmPSIjZSIvPjxsaW5lYXJHcmFkaWVudCBpZD0ibCIgeDE9IjI0LjUiIHgyPSIxMi41IiB5MT0iMjUiIHkyPSI3IiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgaHJlZj0iI2UiLz48bGluZWFyR3JhZGllbnQgaWQ9ImsiIHgxPSIyNC41IiB4Mj0iMTIuNSIgeTE9IjI1IiB5Mj0iNyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIGhyZWY9IiNlIi8+PGxpbmVhckdyYWRpZW50IGlkPSJqIiB4MT0iMjQuNSIgeDI9IjEyLjUiIHkxPSIyNSIgeTI9IjciIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBocmVmPSIjZSIvPjxyYWRpYWxHcmFkaWVudCBpZD0iaSIgY3g9IjguNzkxIiBjeT0iNi4wNDgiIHI9IjEzLjY3NCIgZng9IjguNzkxIiBmeT0iNi4wNDgiIGdyYWRpZW50VHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTEuNzg2IDEuOTI0KXNjYWxlKDEuMTcwMDgpIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgaHJlZj0iI2YiLz48L2RlZnM+PHBhdGggZD0ibTMgMjQgMy41LTE0TDI1IDZjNS0xLjA4MSA2IDIgNSA2bC0zIDEyaC00bDItOGMxLTQtMy00LTQgMGwtMiA4aC00bDItOGMxLTQtMy00LTQgMGwtMiA4eiIgc3R5bGU9ImZpbGw6dXJsKCNnKTtzdHJva2U6dXJsKCNoKTtzdHJva2Utd2lkdGg6MjtwYWludC1vcmRlcjpzdHJva2UgZmlsbCBtYXJrZXJzIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtLjUgMSkiLz48cGF0aCBkPSJtMyAyNCAzLjUtMTRMMjUgNmM1LTEuMDgxIDYgMiA1IDZsLTMgMTJoLTRsMi04YzEtNC0zLTQtNCAwbC0yIDhoLTRsMi04YzEtNC0zLTQtNCAwbC0yIDh6IiBzdHlsZT0iZmlsbDp1cmwoI2kpIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtLjUgMSkiLz48cGF0aCBkPSJtNCAxOCAuNS0xaDlsLS41IDFaIiBzdHlsZT0iZmlsbDp1cmwoI2opIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtLjUgMSkiLz48cGF0aCBkPSJtMTYgMTggLjUtMWg1bC0uNSAxWiIgc3R5bGU9ImZpbGw6dXJsKCNrKSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLS41IDEpIi8+PHBhdGggZD0ibTI0IDE4IC41LTFoNWwtLjUgMVoiIHN0eWxlPSJmaWxsOnVybCgjbCkiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0uNSAxKSIvPjxwYXRoIGQ9Im0zIDI0IDEuNS02aDhMMTEgMjRaIiBzdHlsZT0iZmlsbDp1cmwoI24pIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtLjUgMSkiLz48cGF0aCBkPSJNMTUgMjRoNGwxLjUtNmgtNHoiIHN0eWxlPSJmaWxsOnVybCgjbykiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0uNSAxKSIvPjxwYXRoIGQ9Ik0yNC41IDE4aDRMMjcgMjRoLTR6IiBzdHlsZT0iZmlsbDp1cmwoI3ApIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtLjUgMSkiLz48L3N2Zz4=') left/contain no-repeat;"
);

/** @type {HTMLCanvasElement} */
const canvas = document.getElementById('metro');
/** @type {WebGL2RenderingContext} */
const gl = canvas.getContext('webgl2');

/**
 * @typedef {object} MetroExports
 * @prop {object} exports
 * @prop {WebAssembly.Memory} exports.memory
 * @prop {WebAssembly.Global} exports.metroVarBigEndian
 * @prop {() => 0|1} exports.metroUpdate
 * @prop {() => void} exports.metroMain
 * 
*/

/**
 * @typedef {WebAssembly.Instance & MetroExports} Metro
*/
const context = {
	/** @type {Metro} */
	metro: null,
};

/** @type {?ArrayBuffer} */
let cachedSaveData = null;

const importObject = {
	metroSys: {
		/**
		 * @return {number} The time (in milliseconds) since program start.
		 */
		getTime: function () {
			// TODO: stub...?
			return performance.now();
		},


		loadPersistent: function (
			dataPtr,
			dataLen,
		) {
			// let loaded = localStorage.getItem('metroPersistent');
			// if (cachedSaveData) {
			// 	cachedSaveData
			// }
			throw Error("persistent data unimplemented");
		},

		savePersistent: function (
			dataPtr,
			dataLen,
		) {
			throw Error("persistent data unimplemented");
			// try {
			// 	cachedSaveData = context.metro.exports.memory.buffer.slice(dataPtr, dataPtr + dataLen);
			// 	let encoded = String.fromCharCode(...(new Uint16Array(cachedSaveData)));
			// 	localStorage.setItem('metroPersistent', encoded);
			// } catch (err) {
			// 	console.error('');
			// 	return 1;
			// }
		},

		createBuffer: function (
			bufferType,
			dataPtr,
			dataLen,
		) {
			let buffer = gl.createBuffer();
			// This is enum conversion.
			let target = [gl.ARRAY_BUFFER, gl.ELEMENT_ARRAY_BUFFER, gl.UNIFORM_BUFFER][bufferType];
			// I've designed the API in such a way that makes it impossible to really re-use buffers
			// as the game developer, so pretty much every buffer will be STATIC_DRAW.
			let usage = gl.STATIC_DRAW;
			gl.bindBuffer(
				target,
				buffer,
			);
			gl.bufferData(
				target,
				dataLen,
				context.metro.exports.memory.buffer.slice(dataPtr, dataPtr + dataLen),
				usage
			);
		}
	}
};

{
	console.info("Loading Metro WASM...");
	let bt = performance.now();
	context.metro = (await WebAssembly.instantiateStreaming(
		fetch("metro-game.wasm"),
		importObject
	)).instance;
	let pt = performance.now();
	console.info(`Done loading! (complete in ${pt - bt}ms)`);
}

{
	// https://bsky.app/profile/addie.sh/post/3lqq6ixhjp22q
	let u32 = new Uint32Array([0xDEADBEEF]);
	let u8 = new Uint8Array(u32.buffer);
	let addr = context.metro.exports.metroVarBigEndian.value;
	let view = new DataView(context.metro.exports.memory.buffer, addr, 4);

	switch (u8[0]) {
		case 0xDE: {
			console.info("running on big-endian system, enabling tranpose flag");
			view.setUint32(0, 1, true);
			break;
		}
		case 0xEF: {
			console.info("running on little-endian system, no corrections required");
			view.setUint32(0, 0, true);
			break;
		}
		default: {
			// :(
			throw Error(`Eldritch endianness (0x${u8[0].toString('16')}${u8[1].toString('16')}${u8[2].toString('16')}${u8[3].toString('16')})`);
		}
	}
}

let eventQueue = [];

{
	/** @type {Gamepad[]} */
	let gamepads = [];
	/** @type {Map<string, bool>} */
	let keyState = new Map();

	canvas.addEventListener('keydown', e => {
		// e.key
	});
	canvas.addEventListener('keyup', e => {

	});

	window.addEventListener("gamepadconnected", e => {
		gamepads.push(e.gamepad);
		console.log(`Gamepad connected at index ${e.gamepad.index}: ${e.gamepad.id}. ${e.gamepad.buttons.length} buttons, ${e.gamepad.axes.length} axes.`);
		console.log(gamepads);
	});

	window.addEventListener("gamepaddisconnected", e => {
		console.log(`Gamepad disconnected at index ${e.gamepad.index}: ${e.gamepad.id}.`);
		gamepads = gamepads.filter(v => v.index == e.gamepad.index);
		console.log(gamepads);
	});
}

let isRunning = true;

// initialize stuff
context.metro.exports.metroMain();

function main() {

	// gl.viewport
	let res = context.metro.exports.metroUpdate();
	if (res == 0) {
		isRunning = false;
	}

	if (isRunning) {
		requestAnimationFrame(main);
	}
}

main();